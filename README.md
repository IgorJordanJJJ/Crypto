# 🏗️ Crypto DeFi Analyzer

Платформа для анализа данных криптовалют и DeFi протоколов с интерактивными графиками и таблицами, созданная для выполнения серии лабораторных работ по анализу данных.

## 📋 Описание проекта

Crypto DeFi Analyzer - это комплексное решение для сбора, хранения и анализа данных криптовалютного рынка и протоколов децентрализованных финансов (DeFi). Проект построен с использованием современных технологий и предназначен для выполнения четырех взаимосвязанных лабораторных работ.

### 🎯 Лабораторные работы

1. **Лабораторная работа №1** ✅ - Работа с базами данных и вывод данных в виде таблиц
2. **Лабораторная работа №2** ⏳ - Представление данных с проверкой на нормальность и корреляционный анализ  
3. **Лабораторная работа №3** ⏳ - Аппроксимация данных полиномами и прогнозирование
4. **Лабораторная работа №4** ⏳ - Применение метода K-means к выбранным данным

## 🏗️ Архитектура проекта

### Выбор технологий и обоснование

#### Backend технологии
- **Python 3.11+** - современная версия Python с улучшенной производительностью
- **FastAPI** - высокопроизводительный веб-фреймворк для создания API с автоматической генерацией документации
- **Pydantic** - валидация данных и управление настройками с помощью Python типов
- **SQLAlchemy** - ORM для работы с базами данных, обеспечивает абстракцию и безопасность

#### База данных
- **PostgreSQL** - мощная реляционная СУБД, выбрана по следующим причинам:
  - Отличная поддержка транзакций и ACID
  - Богатая экосистема расширений и инструментов
  - Стабильная работа с foreign keys и ограничениями
  - Превосходная интеграция с Superset и аналитическими инструментами
  - Высокая надежность и производительность

#### Источники данных
- **Bybit API** - бесплатный публичный API для получения данных о криптовалютах (котировки, история, объемы) - не требует API-ключа для чтения
- **DefiLlama API** - бесплатный публичный API для получения данных о DeFi протоколах и TVL (не требует API-ключа)

#### Frontend и UI
- **Jinja2 Templates** - серверный рендеринг HTML страниц
- **HTMX** - современный подход к интерактивности без сложного JavaScript
- **Bootstrap 5** - современный CSS фреймворк для адаптивного дизайна
- **Plotly.js** - интерактивные графики и визуализации

#### Контейнеризация и развертывание
- **Docker** - контейнеризация приложения для консистентного развертывания
- **Docker Compose** - оркестрация многоконтейнерного приложения
- **Nginx** - реверс-прокси и балансировщик нагрузки

#### Бизнес-аналитика и визуализация
- **Apache Superset** - современная BI платформа для создания интерактивных дашбордов
- **PostgreSQL** - основная база данных для хранения всех данных приложения + метаданные Superset
- **Redis** - кэширование запросов и асинхронная обработка для ускорения аналитики

#### Дополнительные библиотеки
- **Alembic** - система миграций базы данных для SQLAlchemy
- **httpx** - асинхронный HTTP клиент для API запросов
- **APScheduler** - планировщик задач для автоматического обновления данных
- **pandas** - обработка и анализ данных
- **numpy** - математические операции
- **scikit-learn** - машинное обучение для будущих лабораторных работ

### Паттерны проектирования

#### 1. Repository Pattern
Реализован полноценный Repository Pattern с базовыми классами:
- `BaseRepository` - базовый класс с общими методами
- `SearchableRepository` - поддержка поиска
- `FilterableRepository` - поддержка фильтрации
- Отдельные репозитории для каждой сущности

#### 2. Mapper Pattern  
Преобразование данных между слоями приложения:
- `CryptocurrencyMapper` - для криптовалют
- `DeFiProtocolMapper` - для DeFi протоколов
- `PriceHistoryMapper`, `MarketDataMapper`, `TVLHistoryMapper`

#### 3. Controller Pattern
Разделение логики по отдельным контроллерам:
- `CryptocurrencyController` - логика работы с криптовалютами
- `DeFiController` - логика работы с DeFi
- `DataController` - управление данными
- `WebController` - веб-страницы и HTMX эндпоинты

#### 4. Batch Processing Pattern (Spring Batch подход)
Реализован в `app/services/batch_processor.py`:
- Разбиение данных на батчи
- Retry логика при ошибках
- Параллельная обработка
- Логирование процесса

#### 5. Factory Pattern
Создание роутеров и контроллеров через фабричные функции

## 📊 Модель данных

### Схема базы данных

```
┌─────────────────┐    ┌──────────────────┐
│ cryptocurrencies│    │   price_history  │
├─────────────────┤    ├──────────────────┤
│ id (PK)         │◄──┤│ cryptocurrency_id│
│ symbol          │    │ timestamp        │
│ name            │    │ price_usd        │
│ market_cap_rank │    │ volume_24h       │
│ description     │    │ market_cap       │
│ website         │    │ price_change_24h │
│ blockchain      │    └──────────────────┘
│ created_at      │
│ updated_at      │    ┌──────────────────┐
└─────────────────┘    │   market_data    │
                       ├──────────────────┤
┌─────────────────┐    │ cryptocurrency_id│
│ defi_protocols  │    │ timestamp        │
├─────────────────┤    │ total_supply     │
│ id (PK)         │    │ circulating_supp │
│ name            │    │ max_supply       │
│ category        │    │ ath              │
│ chain           │    │ atl              │
│ tvl             │    │ roi_percentage   │
│ native_token_id │    └──────────────────┘
│ website         │
│ description     │    ┌──────────────────┐
│ created_at      │    │   tvl_history    │
│ updated_at      │◄──┤│ protocol_id      │
└─────────────────┘    │ timestamp        │
                       │ tvl              │
                       │ tvl_change_24h   │
                       └──────────────────┘
```

### Основные таблицы

1. **cryptocurrencies** - основная информация о криптовалютах
2. **price_history** - исторические данные цен
3. **market_data** - рыночные показатели
4. **defi_protocols** - информация о DeFi протоколах  
5. **tvl_history** - история Total Value Locked

## 🚀 Установка и запуск

### Предварительные требования
- Python 3.11+
- Poetry (для управления зависимостями)
- Docker и Docker Compose (опционально)

### Установка

1. **Клонирование проекта**
```bash
git clone <repository-url>
cd crypto-defi-analyzer
```

2. **Установка зависимостей**
```bash
# Установка Poetry (если не установлен)
curl -sSL https://install.python-poetry.org | python3 -

# Установка зависимостей проекта
poetry install
```

3. **Настройка переменных окружения**
```bash
cp .env.example .env
# Отредактируйте .env файл при необходимости (API ключи не требуются)
```

### Запуск с Docker (рекомендуется)

```bash
# Запуск всех сервисов
docker-compose up -d

# Просмотр логов
docker-compose logs -f

# Остановка сервисов
docker-compose down
```

### Запуск без Docker

```bash
# Установка и запуск PostgreSQL отдельно
# Инструкции: https://www.postgresql.org/download/

# Инициализация и загрузка данных
make setup

# Запуск сервера разработки
make dev
```

## 🔧 Использование

### Команды Makefile

```bash
make help          # Показать все доступные команды
make install       # Установить зависимости
make setup         # Инициализация БД, миграции и загрузка данных
make dev           # Запуск сервера разработки
make prod          # Запуск продакшн сервера
make scheduler     # Запуск планировщика данных
make docker-up     # Запуск с Docker
make clean         # Очистка временных файлов
```

### Команды run.py (с Alembic поддержкой)

```bash
# Инициализация базы данных
python run.py init-db

# Миграции Alembic
python run.py migrate                    # Применить миграции
python run.py make-migration "message"   # Создать новую миграцию
python run.py migration-history          # История миграций
python run.py migration-current          # Текущая миграция

# Данные и сервер
python run.py load-data                  # Загрузка данных
python run.py dev                        # Сервер разработки  
python run.py prod                       # Продакшн сервер
python run.py scheduler                  # Планировщик
python run.py setup                      # Полная инициализация (БД + миграции + данные)
```

## 🌐 API и интерфейс

### Веб-интерфейс (с HTMX)
- **Главная страница**: `http://localhost:8000/`
- **Криптовалюты**: `http://localhost:8000/cryptocurrencies` (интерактивные таблицы с HTMX)
- **DeFi протоколы**: `http://localhost:8000/defi` (динамическая фильтрация)
- **Аналитика**: `http://localhost:8000/analytics`

### Apache Superset (Дашборды и BI)
- **Superset Dashboard**: `http://localhost:8088` (логин: admin / пароль: admin)
- **Подробная документация**: [SUPERSET.md](SUPERSET.md)
- **Готовые графики**: 10+ профессиональных дашбордов для анализа крипто и DeFi данных

### API эндпоинты
- **Документация API**: `http://localhost:8000/docs`
- **Интерактивная документация**: `http://localhost:8000/redoc`
- **Здоровье системы**: `http://localhost:8000/health`

#### Основные API маршруты:

```
# Криптовалюты
GET  /api/cryptocurrencies                        # Список криптовалют
GET  /api/cryptocurrencies/{id}                   # Детали криптовалюты
GET  /api/cryptocurrencies/{id}/price-history     # История цен
GET  /api/cryptocurrencies/{id}/market-data       # Рыночные данные

# DeFi протоколы  
GET  /api/defi/protocols                          # DeFi протоколы
GET  /api/defi/protocols/{id}                     # Детали протокола
GET  /api/defi/protocols/{id}/tvl-history         # История TVL
GET  /api/defi/top-protocols                      # Топ протоколы по TVL
GET  /api/defi/categories/summary                 # Статистика по категориям
GET  /api/defi/chains/summary                     # Статистика по блокчейнам

# Аналитика
GET  /api/analytics/top-gainers                   # Топ растущих
GET  /api/analytics/top-losers                    # Топ падающих
GET  /api/analytics/market-summary                # Сводка рынка

# Управление данными
POST /api/data/refresh                            # Обновление данных
GET  /api/data/status                            # Статус данных

# HTMX эндпоинты (для партиалов)
GET  /partials/crypto-table                      # Таблица криптовалют
GET  /partials/defi-table                        # Таблица DeFi
GET  /partials/crypto-details/{id}               # Детали криптовалюты
GET  /partials/defi-details/{id}                 # Детали протокола
```

Создание миграций
Обратите внимание на разницу:
```bash
alembic revision -m 'initial' - создает пустой скрипт миграции без генерации кода на основе моделей.
```
```bash
alembic revision --autogenerate -m 'initial' - анализирует ваши модели и текущее состояние базы данных, и создает скрипт миграции на основе различий.
```
Накатывание миграция
```bash
alembic upgrade head
```

## 📈 Особенности реализации

### Batch Processing
Система использует паттерн пакетной обработки данных, схожий с Spring Batch:
- Разбиение на батчи для эффективной обработки памяти
- Retry механизм для обработки ошибок сети
- Параллельная обработка с контролем concurrency
- Логирование и мониторинг процесса

### Архитектурные решения

#### Слоистая архитектура
- **Controllers** - обработка HTTP запросов и бизнес-логика
- **Repositories** - абстракция доступа к данным  
- **Mappers** - преобразование между моделями и DTO
- **Services** - бизнес-логика и внешние интеграции
- **Schemas** - Pydantic модели для валидации данных

#### HTMX интеграция
- Динамическое обновление контента без полной перезагрузки
- Серверный рендеринг с клиентской интерактивностью
- Партиальные шаблоны для компонентов
- Индикаторы загрузки и обработки ошибок

#### Миграции Alembic
- Версионирование схемы базы данных
- Автогенерация миграций из моделей SQLAlchemy
- Откат к предыдущим версиям
- История изменений схемы

### Асинхронность
- Асинхронные HTTP запросы к API
- Неблокирующая обработка данных
- Concurrent выполнение задач

### Caching и оптимизация
- Эффективные запросы к ClickHouse
- Пагинация для больших наборов данных
- Сжатие данных в ClickHouse

### Мониторинг и логирование
- Структурированные логи
- Health check эндпоинты
- Метрики Docker контейнеров

## 🔒 Безопасность

- Валидация входных данных через Pydantic
- Rate limiting через Nginx
- Безопасные headers
- Отсутствие хардкодных секретов
- Изоляция через Docker контейнеры

## 📝 Планы развития

### Лабораторная работа №2
- Реализация проверки нормальности данных
- Построение гистограмм распределения
- Графики квантилей
- Корреляционная матрица с тепловой картой

### Лабораторная работа №3
- Полиномиальная аппроксимация (1-5 порядок)
- Краткосрочное прогнозирование
- Визуализация результатов с легендой
- Подписи осей и метрики качества

### Лабораторная работа №4
- Кластеризация методом K-means
- Визуализация кластеров
- Анализ результатов кластеризации
- Интерпретация групп данных

### Дополнительные улучшения
- Система уведомлений
- Экспорт данных в различные форматы
- Расширенная аналитика
- Машинное обучение для прогнозирования
- WebSocket для real-time данных

## 🤝 Вклад в проект

1. Fork репозитория
2. Создайте feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit изменения (`git commit -m 'Add some AmazingFeature'`)
4. Push в branch (`git push origin feature/AmazingFeature`)
5. Откройте Pull Request

## 📄 Лицензия

Проект создан для образовательных целей в рамках выполнения лабораторных работ.

## 🆘 Поддержка

При возникновении проблем:
1. Проверьте логи: `docker-compose logs -f`
2. Убедитесь в корректности .env файла
3. API ключи не требуются (Bybit и DefiLlama предоставляют бесплатный доступ к публичным данным)
4. Убедитесь в запуске PostgreSQL

## 🏷️ Версии

- **v0.1.0** - Базовая функциональность, Лабораторная работа №1
- **v0.2.0** - Планируется: Статистический анализ, Лабораторная работа №2
- **v0.3.0** - Планируется: Прогнозирование, Лабораторная работа №3  
- **v0.4.0** - Планируется: Кластеризация, Лабораторная работа №4

---

**Разработано с ❤️ для изучения современных технологий анализа данных**

## 📊 Особенности API интеграций

### Bybit API
- ✅ **Бесплатный доступ** к публичным данным без регистрации
- ✅ **Надежные данные** с крупнейшей криптобиржи
- ✅ **Реальные котировки** - актуальные цены и объемы
- ✅ **Исторические данные** - свечи (OHLCV) с разными интервалами
- ✅ **Высокая производительность** и стабильность API

### DefiLlama API  
- ✅ **Полностью бесплатный** - без лимитов и ключей
- ✅ **Самые полные DeFi данные** - 3000+ протоколов
- ✅ **TVL по сетям** - Ethereum, BSC, Polygon и 100+ чейнов
- ✅ **История и динамика** - изменения TVL, доходы протоколов
- ✅ **Категории DeFi** - DEX, Lending, Yield Farming и др.


1. Сначала удаляем все существующие окружения
   powershell
# Удаляем все окружения проекта
poetry env remove --all

# Также можно удалить вручную кэш если нужно
Remove-Item -Recurse -Force ~\AppData\Local\pypoetry\Cache\virtualenvs\crypto-defi-analyzer-* -ErrorAction SilentlyContinue
2. Настраиваем создание .venv внутри проекта
   powershell
# ВАЖНО: сначала настройка, потом создание!
poetry config virtualenvs.in-project true
3. Теперь создаем окружение
   powershell
# Создаем новое окружение УЖЕ внутри проекта
poetry env use 3.12
4. Проверяем результат
   powershell
# Теперь должно создаться в папке проекта
poetry env info

# Проверяем что папка .venv появилась в проекте
ls -Force


запустить приложение командой:
.venv\Scripts\python.exe -m uvicorn app.main:app --reload

И протестировать API на:
- Главная страница: http://127.0.0.1:8000/
- Страница тестирования данных: http://127.0.0.1:8000/data-testing
- API документация: http://127.0.0.1:8000/docs

Все репозитории теперь работают с PostgreSQL через SQLAlchemy, и API endpoints для ручного тестирования Bybit и DefiLlama готовы к использованию!

📊 Теперь графики будут показывать:

График цен:
- Основную линию цены (синяя)
- Bid prices (зеленая пунктир)
- Ask prices (красная пунктир)
- Интерактивные подсказки

График объемов:
- Столбцы объема торгов
- Столбцы оборота (если есть Bybit данные)
- Профессиональное форматирование
